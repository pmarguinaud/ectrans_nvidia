! (C) Copyright 2022- NVIDIA.
!
! This software is licensed under the terms of the Apache Licence Version 2.0
! which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.
! In applying this licence, ECMWF does not waive the privileges and immunities
! granted to it by virtue of its status as an intergovernmental organisation
! nor does it submit to any jurisdiction.
MODULE CUDA_GEMM_BATCHED_MOD
  USE PARKIND1, ONLY: JPRD, JPRM, JPIM
  USE CUBLAS, ONLY: CUBLAS_OP_N, CUBLAS_OP_T
  USE ISO_C_BINDING
  USE OPENACC, ONLY: ACC_GET_CUDA_STREAM
  USE GROWING_ALLOCATOR_MOD, ONLY: GROWING_ALLOCATION_TYPE

  IMPLICIT NONE

  PUBLIC CUBLAS_OP_N, CUBLAS_OP_T
  PUBLIC CUDA_GEMM_BATCHED

  INTERFACE CUDA_GEMM_BATCHED
    MODULE PROCEDURE CUDA_DGEMM_BATCHED_OVERLOAD
    MODULE PROCEDURE CUDA_SGEMM_BATCHED_OVERLOAD
    MODULE PROCEDURE CUDA_DGEMM_GROUPED_OVERLOAD
    MODULE PROCEDURE CUDA_SGEMM_GROUPED_OVERLOAD
  END INTERFACE CUDA_GEMM_BATCHED

  INTERFACE
    SUBROUTINE CUDA_SGEMM_BATCHED(&
        & CTA, CTB,               &
        & M, N, K,                &
        & ALPHA,                  &
        & A, LDA, TDA,            &
        & B, LDB, TDB,            &
        & BETA,                   &
        & C, LDC, TDC,            &
        & BATCHCOUNT, STREAM, ALLOC&
    &) BIND(C, NAME='cublas_sgemm_wrapper')
        USE ISO_C_BINDING
        INTEGER(C_INT), VALUE :: CTA, CTB, M, N, K, LDA, LDB, LDC, TDA, TDB, TDC, BATCHCOUNT
        REAL(C_FLOAT), VALUE  :: ALPHA,BETA
        REAL(C_FLOAT)         :: A(*), B(*), C(*)
#ifdef _CUDA
      ATTRIBUTES(DEVICE) :: A,B,C
#endif
        INTEGER(KIND=c_size_t) :: STREAM
        TYPE(C_PTR), INTENT(IN), VALUE :: ALLOC
    END SUBROUTINE CUDA_SGEMM_BATCHED
    SUBROUTINE CUDA_DGEMM_BATCHED(&
        & CTA, CTB,               &
        & M, N, K,                &
        & ALPHA,                  &
        & A, LDA, TDA,            &
        & B, LDB, TDB,            &
        & BETA,                   &
        & C, LDC, TDC,            &
        & BATCHCOUNT, STREAM, ALLOC&
    &) BIND(C, NAME='cublas_dgemm_wrapper')
        USE ISO_C_BINDING
        INTEGER(C_INT), VALUE :: CTA, CTB, M, N, K, LDA, LDB, LDC, TDA, TDB, TDC, BATCHCOUNT
        REAL(C_DOUBLE), VALUE :: ALPHA,BETA
        REAL(C_DOUBLE)        :: A(*), B(*), C(*)
#ifdef _CUDA
      ATTRIBUTES(DEVICE) :: A,B,C
#endif
        INTEGER(KIND=c_size_t) :: STREAM
        TYPE(C_PTR), INTENT(IN), VALUE :: ALLOC
    END SUBROUTINE CUDA_DGEMM_BATCHED
    SUBROUTINE CUDA_DGEMM_GROUPED(&
        & BLAS_ID, CTA, CTB,      &
        & M, N, K,                &
        & ALPHA,                  &
        & A, LDA, OFFSETA,        &
        & B, LDB, OFFSETB,        &
        & BETA,                   &
        & C, LDC, OFFSETC,        &
        & BATCHCOUNT, STREAM, ALLOC&
    &) BIND(C, NAME='blas_dgemm_wrapper_grouped')
        USE ISO_C_BINDING
        INTEGER(C_INT), VALUE :: BLAS_ID, CTA, CTB, M, N(:), K(:), LDA, LDB, LDC, OFFSETA(:), OFFSETB(:), OFFSETC(:), BATCHCOUNT
        REAL(C_DOUBLE), VALUE  :: ALPHA,BETA
        REAL(C_DOUBLE)         :: A(*), B(*), C(*)
#ifdef _CUDA
      ATTRIBUTES(DEVICE) :: A,B,C
#endif
        INTEGER(KIND=c_size_t) :: STREAM
        TYPE(C_PTR), INTENT(IN), VALUE :: ALLOC
    END SUBROUTINE CUDA_DGEMM_GROUPED
    SUBROUTINE CUDA_SGEMM_GROUPED(&
        & BLAS_ID, CTA, CTB,      &
        & M, N, K,                &
        & ALPHA,                  &
        & A, LDA, OFFSETA,        &
        & B, LDB, OFFSETB,        &
        & BETA,                   &
        & C, LDC, OFFSETC,        &
        & BATCHCOUNT, STREAM, ALLOC&
    &) BIND(C, NAME='blas_sgemm_wrapper_grouped')
        USE ISO_C_BINDING
        INTEGER(C_INT), VALUE :: BLAS_ID, CTA, CTB, M, N(:), K(:), LDA, LDB, LDC, OFFSETA(:), OFFSETB(:), OFFSETC(:), BATCHCOUNT
        REAL(C_FLOAT), VALUE  :: ALPHA,BETA
        REAL(C_FLOAT)         :: A(*), B(*), C(*)
#ifdef _CUDA
      ATTRIBUTES(DEVICE) :: A,B,C
#endif
        INTEGER(KIND=c_size_t) :: STREAM
        TYPE(C_PTR), INTENT(IN), VALUE :: ALLOC
    END SUBROUTINE CUDA_SGEMM_GROUPED
  END INTERFACE

CONTAINS

SUBROUTINE CUDA_DGEMM_BATCHED_OVERLOAD( &
      & TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, STRIDEA, &
      & BARRAY, LDB, STRIDEB, &
      & BETA, &
      & CARRAY, LDC, STRIDEC, &
      & BATCHCOUNT, STREAM, ALLOC)
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSA
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSB
    INTEGER(KIND=JPIM) :: M
    INTEGER(KIND=JPIM) :: N
    INTEGER(KIND=JPIM) :: K
    REAL(KIND=JPRD) :: ALPHA
    REAL(KIND=JPRD), DIMENSION(:) :: AARRAY
    INTEGER(KIND=JPIM) :: LDA
    INTEGER(KIND=JPIM) :: STRIDEA
    REAL(KIND=JPRD), DIMENSION(*) :: BARRAY
    INTEGER(KIND=JPIM) :: LDB
    INTEGER(KIND=JPIM) :: STRIDEB
    REAL(KIND=JPRD) :: BETA
    REAL(KIND=JPRD), DIMENSION(:) :: CARRAY
    INTEGER(KIND=JPIM) :: LDC
    INTEGER(KIND=JPIM) :: STRIDEC
    INTEGER(KIND=JPIM) :: BATCHCOUNT
    INTEGER(KIND=C_LONG) :: STREAM
    TYPE(GROWING_ALLOCATION_TYPE), INTENT(IN) :: ALLOC

    !$ACC HOST_DATA USE_DEVICE(AARRAY,BARRAY,CARRAY)
    CALL CUDA_DGEMM_BATCHED( &
      & TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, STRIDEA, &
      & BARRAY, LDB, STRIDEB, &
      & BETA, &
      & CARRAY, LDC, STRIDEC, &
      & BATCHCOUNT, ACC_GET_CUDA_STREAM(STREAM), C_LOC(ALLOC))
    !$ACC END HOST_DATA
  END SUBROUTINE CUDA_DGEMM_BATCHED_OVERLOAD

  SUBROUTINE CUDA_SGEMM_BATCHED_OVERLOAD( &
      & TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, STRIDEA, &
      & BARRAY, LDB, STRIDEB, &
      & BETA, &
      & CARRAY, LDC, STRIDEC, &
      & BATCHCOUNT, STREAM, ALLOC)
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSA
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSB
    INTEGER(KIND=JPIM) :: M
    INTEGER(KIND=JPIM) :: N
    INTEGER(KIND=JPIM) :: K
    REAL(KIND=JPRM) :: ALPHA
    REAL(KIND=JPRM), DIMENSION(:) :: AARRAY
    INTEGER(KIND=JPIM) :: LDA
    INTEGER(KIND=JPIM) :: STRIDEA
    REAL(KIND=JPRM), DIMENSION(*) :: BARRAY
    INTEGER(KIND=JPIM) :: LDB
    INTEGER(KIND=JPIM) :: STRIDEB
    REAL(KIND=JPRM) :: BETA
    REAL(KIND=JPRM), DIMENSION(:) :: CARRAY
    INTEGER(KIND=JPIM) :: LDC
    INTEGER(KIND=JPIM) :: STRIDEC
    INTEGER(KIND=JPIM) :: BATCHCOUNT
    INTEGER(KIND=C_LONG) :: STREAM
    TYPE(GROWING_ALLOCATION_TYPE), INTENT(IN) :: ALLOC

    !$ACC HOST_DATA USE_DEVICE(AARRAY,BARRAY,CARRAY)
    CALL CUDA_SGEMM_BATCHED( &
      & TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, STRIDEA, &
      & BARRAY, LDB, STRIDEB, &
      & BETA, &
      & CARRAY, LDC, STRIDEC, &
      & BATCHCOUNT, ACC_GET_CUDA_STREAM(STREAM), C_LOC(ALLOC))
    !$ACC END HOST_DATA
  END SUBROUTINE CUDA_SGEMM_BATCHED_OVERLOAD

  SUBROUTINE CUDA_DGEMM_GROUPED_OVERLOAD( &
      & BLAS_ID, TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, OFFSETA, &
      & BARRAY, LDB, OFFSETB, &
      & BETA, &
      & CARRAY, LDC, OFFSETC, &
      & BATCHCOUNT, STREAM, ALLOC)
    INTEGER(KIND=C_INT), INTENT(IN) :: BLAS_ID
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSA
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSB
    INTEGER(KIND=JPIM) :: M
    INTEGER(KIND=JPIM) :: N(:)
    INTEGER(KIND=JPIM) :: K(:)
    REAL(KIND=JPRD) :: ALPHA
    REAL(KIND=JPRD), DIMENSION(:) :: AARRAY
    INTEGER(KIND=JPIM) :: LDA
    INTEGER(KIND=JPIM) :: OFFSETA(:)
    REAL(KIND=JPRD), DIMENSION(*) :: BARRAY
    INTEGER(KIND=JPIM) :: LDB
    INTEGER(KIND=JPIM) :: OFFSETB(:)
    REAL(KIND=JPRD) :: BETA
    REAL(KIND=JPRD), DIMENSION(:) :: CARRAY
    INTEGER(KIND=JPIM) :: LDC
    INTEGER(KIND=JPIM) :: OFFSETC(:)
    INTEGER(KIND=JPIM) :: BATCHCOUNT
    INTEGER(KIND=C_LONG) :: STREAM
    TYPE(GROWING_ALLOCATION_TYPE), INTENT(IN) :: ALLOC

    !$ACC HOST_DATA USE_DEVICE(AARRAY,BARRAY,CARRAY)
    CALL CUDA_DGEMM_GROUPED( &
      & BLAS_ID, TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, OFFSETA, &
      & BARRAY, LDB, OFFSETB, &
      & BETA, &
      & CARRAY, LDC, OFFSETC, &
      & BATCHCOUNT, ACC_GET_CUDA_STREAM(STREAM), C_LOC(ALLOC))
    !$ACC END HOST_DATA
  END SUBROUTINE CUDA_DGEMM_GROUPED_OVERLOAD

  SUBROUTINE CUDA_SGEMM_GROUPED_OVERLOAD( &
      & BLAS_ID, TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, OFFSETA, &
      & BARRAY, LDB, OFFSETB, &
      & BETA, &
      & CARRAY, LDC, OFFSETC, &
      & BATCHCOUNT, STREAM, ALLOC)
    INTEGER(KIND=C_INT), INTENT(IN) :: BLAS_ID
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSA
    INTEGER(KIND=C_INT), INTENT(IN) :: TRANSB
    INTEGER(KIND=JPIM) :: M
    INTEGER(KIND=JPIM) :: N(:)
    INTEGER(KIND=JPIM) :: K(:)
    REAL(KIND=JPRM) :: ALPHA
    REAL(KIND=JPRM), DIMENSION(:) :: AARRAY
    INTEGER(KIND=JPIM) :: LDA
    INTEGER(KIND=JPIM) :: OFFSETA(:)
    REAL(KIND=JPRM), DIMENSION(*) :: BARRAY
    INTEGER(KIND=JPIM) :: LDB
    INTEGER(KIND=JPIM) :: OFFSETB(:)
    REAL(KIND=JPRM) :: BETA
    REAL(KIND=JPRM), DIMENSION(:) :: CARRAY
    INTEGER(KIND=JPIM) :: LDC
    INTEGER(KIND=JPIM) :: OFFSETC(:)
    INTEGER(KIND=JPIM) :: BATCHCOUNT
    INTEGER(KIND=C_LONG) :: STREAM
    TYPE(GROWING_ALLOCATION_TYPE), INTENT(IN) :: ALLOC

    !$ACC HOST_DATA USE_DEVICE(AARRAY,BARRAY,CARRAY)
    CALL CUDA_SGEMM_GROUPED( &
      & BLAS_ID, TRANSA, TRANSB, &
      & M, N, K, &
      & ALPHA, &
      & AARRAY, LDA, OFFSETA, &
      & BARRAY, LDB, OFFSETB, &
      & BETA, &
      & CARRAY, LDC, OFFSETC, &
      & BATCHCOUNT, ACC_GET_CUDA_STREAM(STREAM), C_LOC(ALLOC))
    !$ACC END HOST_DATA
  END SUBROUTINE CUDA_SGEMM_GROUPED_OVERLOAD

END MODULE CUDA_GEMM_BATCHED_MOD
